name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 9.0.x

      - name: Download Dalamud
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri https://goatcorp.github.io/dalamud-distrib/latest.zip -OutFile latest.zip
          Expand-Archive -Force latest.zip "$env:AppData\XIVLauncher\addon\Hooks\dev"

      - name: Build
        shell: pwsh
        run: dotnet build AllaganSync.slnx --configuration Release

      - name: Prepare release assets
        id: assets
        shell: pwsh
        run: |
          $zip = Get-ChildItem -Path "AllaganSync/bin" -Recurse -Filter "latest.zip" | Select-Object -First 1
          if (-not $zip) {
            throw "latest.zip not found under AllaganSync/bin"
          }

          $manifest = Get-Content "AllaganSync/AllaganSync.json" -Raw | ConvertFrom-Json
          [xml]$csproj = Get-Content "AllaganSync/AllaganSync.csproj"
          $version = $csproj.Project.PropertyGroup.Version
          if ([string]::IsNullOrWhiteSpace($version)) {
            throw "Version not found in AllaganSync.csproj"
          }

          $repoUrl = "https://github.com/${{ github.repository }}"
          $latestZipUrl = "$repoUrl/releases/latest/download/latest.zip"
          $lastUpdate = [DateTimeOffset]::UtcNow.ToUnixTimeSeconds()

          $pluginMasterEntry = [ordered]@{
            Author = $manifest.Author
            Name = $manifest.Name
            Punchline = $manifest.Punchline
            Description = $manifest.Description
            ApplicableVersion = $manifest.ApplicableVersion
            Tags = $manifest.Tags
            InternalName = "AllaganSync"
            AssemblyVersion = $version
            RepoUrl = $repoUrl
            DalamudApiLevel = 14
            DownloadLinkInstall = $latestZipUrl
            DownloadLinkUpdate = $latestZipUrl
            DownloadLinkTesting = $latestZipUrl
            LastUpdate = $lastUpdate
          }

          $pluginMasterPath = "pluginmaster.json"
          @($pluginMasterEntry) | ConvertTo-Json -Depth 8 | Set-Content -Path $pluginMasterPath -Encoding utf8NoBOM

          "zip_path=$($zip.FullName)" >> $env:GITHUB_OUTPUT
          "pluginmaster_path=$((Resolve-Path $pluginMasterPath).Path)" >> $env:GITHUB_OUTPUT
          "version=$version" >> $env:GITHUB_OUTPUT

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            ${{ steps.assets.outputs.zip_path }}
            ${{ steps.assets.outputs.pluginmaster_path }}
